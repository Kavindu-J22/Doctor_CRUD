<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle + ' - Doctor Registration System'}">Doctor Form - Doctor Registration System</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" th:href="@{/doctors/list}">
                <i class="fas fa-user-md me-2"></i>
                Doctor Registration System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/doctors/list}">
                            <i class="fas fa-list me-1"></i>All Doctors
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" th:href="@{/doctors/new}">
                            <i class="fas fa-plus me-1"></i>Add Doctor
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4">
        <!-- Error Message -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Enhanced Page Header -->
        <div class="row mb-4 fade-in">
            <div class="col-md-8">
                <h1 class="h2 text-gradient">
                    <i class="fas fa-user-plus me-2" th:if="${doctor.id == null}"></i>
                    <i class="fas fa-user-edit me-2" th:if="${doctor.id != null}"></i>
                    <span th:text="${pageTitle}">Add New Doctor</span>
                </h1>
                <p class="text-light mb-3">
                    <span th:if="${doctor.id == null}">Fill in the information below to register a new doctor in the system.</span>
                    <span th:if="${doctor.id != null}">Update the doctor's information using the form below.</span>
                </p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a th:href="@{/doctors/list}" class="text-decoration-none">
                                <i class="fas fa-users me-1"></i>All Doctors
                            </a>
                        </li>
                        <li class="breadcrumb-item active" th:text="${pageTitle}">Add New Doctor</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex flex-column align-items-end">
                    <div class="stat-card mb-2" style="min-width: 200px;">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-primary text-white me-3">
                                <i class="fas fa-user-md"></i>
                            </div>
                            <div>
                                <div class="stat-value stat-record-text" th:text="${doctor.id == null ? 'New' : 'Edit'}">New</div>
                                <div class="stat-label text-light">Doctor Record</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Doctor Form -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card slide-up">
                    <div class="card-header">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-user-md text-primary me-2"></i>
                                    Doctor Information
                                </h5>
                                <small class="form-required-text">All fields marked with * are required</small>
                            </div>
                            <div class="form-progress">
                                <div class="progress" style="width: 150px; height: 8px;">
                                    <div class="progress-bar bg-primary" role="progressbar"
                                         style="width: 0%" id="formProgress"></div>
                                </div>
                                <small class="text-muted mt-1 d-block">Form completion: <span id="progressText">0%</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/doctors/save}" th:object="${doctor}" method="post" id="doctorForm" novalidate>
                            <!-- Hidden ID field for edit -->
                            <input type="hidden" th:field="*{id}">

                            <!-- Personal Information Section -->
                            <div class="form-section mb-4">
                                <h6 class="section-title text-light">
                                    <i class="fas fa-user text-primary me-2"></i>
                                    Personal Information
                                </h6>
                                <div class="section-divider"></div>

                                <div class="row">
                                    <!-- First Name -->
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label form-field-label">
                                            <i class="fas fa-user me-1"></i>First Name <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-user text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control" th:field="*{firstName}"
                                                   th:classappend="${#fields.hasErrors('firstName')} ? 'is-invalid' : ''"
                                                   placeholder="Enter first name" required>
                                            <div class="valid-feedback">Looks good!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}"
                                                 th:errors="*{firstName}">Please provide a valid first name.</div>
                                        </div>
                                    </div>

                                    <!-- Last Name -->
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label form-field-label">
                                            <i class="fas fa-user me-1"></i>Last Name <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-user text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control" th:field="*{lastName}"
                                                   th:classappend="${#fields.hasErrors('lastName')} ? 'is-invalid' : ''"
                                                   placeholder="Enter last name" required>
                                            <div class="valid-feedback">Looks good!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}"
                                                 th:errors="*{lastName}">Please provide a valid last name.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contact Information Section -->
                            <div class="form-section mb-4">
                                <h6 class="section-title text-light">
                                    <i class="fas fa-address-book text-primary me-2"></i>
                                    Contact Information
                                </h6>
                                <div class="section-divider"></div>

                                <div class="row">
                                    <!-- Email -->
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label form-field-label">
                                            <i class="fas fa-envelope me-1"></i>Email <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-envelope text-muted"></i>
                                            </span>
                                            <input type="email" class="form-control" th:field="*{email}"
                                                   th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''"
                                                   placeholder="doctor@example.com" required>
                                            <div class="valid-feedback">Email format is valid!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}"
                                                 th:errors="*{email}">Please provide a valid email address.</div>
                                        </div>
                                    </div>

                                    <!-- Phone Number -->
                                    <div class="col-md-6 mb-3">
                                        <label for="phoneNumber" class="form-label form-field-label">
                                            <i class="fas fa-phone me-1"></i>Phone Number <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-phone text-muted"></i>
                                            </span>
                                            <input type="tel" class="form-control" th:field="*{phoneNumber}"
                                                   th:classappend="${#fields.hasErrors('phoneNumber')} ? 'is-invalid' : ''"
                                                   placeholder="+94771234567 or 0771234567" required>
                                            <div class="valid-feedback">Sri Lankan phone number looks good!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('phoneNumber')}"
                                                 th:errors="*{phoneNumber}">Please provide a valid Sri Lankan phone number.</div>
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Accepted formats: +94771234567, 0771234567, or 771234567
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Professional Information Section -->
                            <div class="form-section mb-4">
                                <h6 class="section-title text-light">
                                    <i class="fas fa-stethoscope text-primary me-2"></i>
                                    Professional Information
                                </h6>
                                <div class="section-divider"></div>

                                <div class="row">
                                    <!-- Specialization -->
                                    <div class="col-md-6 mb-3">
                                        <label for="specialization" class="form-label form-field-label">
                                            <i class="fas fa-stethoscope me-1"></i>Specialization <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-stethoscope text-muted"></i>
                                            </span>
                                            <select class="form-select" th:field="*{specialization}"
                                                    th:classappend="${#fields.hasErrors('specialization')} ? 'is-invalid' : ''"
                                                    required>
                                                <option value="">Select specialization...</option>
                                                <option value="Cardiology">Cardiology</option>
                                                <option value="Neurology">Neurology</option>
                                                <option value="Orthopedics">Orthopedics</option>
                                                <option value="Pediatrics">Pediatrics</option>
                                                <option value="Dermatology">Dermatology</option>
                                                <option value="Psychiatry">Psychiatry</option>
                                                <option value="Radiology">Radiology</option>
                                                <option value="Surgery">Surgery</option>
                                                <option value="Internal Medicine">Internal Medicine</option>
                                                <option value="Emergency Medicine">Emergency Medicine</option>
                                                <option value="Other">Other</option>
                                            </select>
                                            <div class="valid-feedback">Great choice!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('specialization')}"
                                                 th:errors="*{specialization}">Please select a specialization.</div>
                                        </div>
                                    </div>

                                    <!-- Years of Experience -->
                                    <div class="col-md-6 mb-3">
                                        <label for="yearsOfExperience" class="form-label form-field-label">
                                            <i class="fas fa-calendar-alt me-1"></i>Years of Experience <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-calendar-alt text-muted"></i>
                                            </span>
                                            <input type="number" class="form-control" th:field="*{yearsOfExperience}"
                                                   th:classappend="${#fields.hasErrors('yearsOfExperience')} ? 'is-invalid' : ''"
                                                   min="0" max="50" placeholder="0" required>
                                            <span class="input-group-text">years</span>
                                            <div class="valid-feedback">Experience noted!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('yearsOfExperience')}"
                                                 th:errors="*{yearsOfExperience}">Please enter years of experience (0-50).</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <!-- Hospital/Clinic -->
                                    <div class="col-md-6 mb-3">
                                        <label for="hospitalClinic" class="form-label form-field-label">
                                            <i class="fas fa-hospital me-1"></i>Hospital/Clinic <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-hospital text-muted"></i>
                                            </span>
                                            <input type="text" class="form-control" th:field="*{hospitalClinic}"
                                                   th:classappend="${#fields.hasErrors('hospitalClinic')} ? 'is-invalid' : ''"
                                                   placeholder="e.g., City General Hospital" required>
                                            <div class="valid-feedback">Hospital/Clinic recorded!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('hospitalClinic')}"
                                                 th:errors="*{hospitalClinic}">Please provide hospital or clinic name.</div>
                                        </div>
                                    </div>

                                    <!-- Date of Birth -->
                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfBirth" class="form-label form-field-label">
                                            <i class="fas fa-birthday-cake me-1"></i>Date of Birth <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-birthday-cake text-muted"></i>
                                            </span>
                                            <input type="date" class="form-control" th:field="*{dateOfBirth}"
                                                   th:classappend="${#fields.hasErrors('dateOfBirth')} ? 'is-invalid' : ''"
                                                   required>
                                            <div class="valid-feedback">Date of birth recorded!</div>
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('dateOfBirth')}"
                                                 th:errors="*{dateOfBirth}">Please provide a valid date of birth.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information Section -->
                            <div class="form-section mb-4">
                                <h6 class="section-title text-light">
                                    <i class="fas fa-info-circle text-primary me-2"></i>
                                    Additional Information
                                </h6>
                                <div class="section-divider"></div>

                                <!-- Address -->
                                <div class="mb-4">
                                    <label for="address" class="form-label form-field-label">
                                        <i class="fas fa-map-marker-alt me-1"></i>Address <small class="text-muted">(Optional)</small>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-map-marker-alt text-muted"></i>
                                        </span>
                                        <textarea class="form-control" th:field="*{address}" rows="3"
                                                  th:classappend="${#fields.hasErrors('address')} ? 'is-invalid' : ''"
                                                  placeholder="Enter full address including street, city, state, and postal code"></textarea>
                                        <div class="valid-feedback">Address information saved!</div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('address')}"
                                             th:errors="*{address}">Please provide a valid address.</div>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        This information helps patients locate your practice.
                                    </div>
                                </div>
                            </div>

                            <!-- Enhanced Form Actions -->
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="form-help">
                                        <small class="text-light">
                                            <i class="fas fa-shield-alt me-1 text-success"></i>
                                            All information is securely stored and encrypted.
                                        </small>
                                    </div>
                                    <div class="form-actions">
                                        <a th:href="@{/doctors/list}" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-arrow-left me-2"></i>Back to List
                                        </a>
                                        <button type="reset" class="btn btn-outline-warning me-2" onclick="resetForm()">
                                            <i class="fas fa-undo me-2"></i>Reset Form
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="submitBtn">
                                            <span class="btn-text">
                                                <i class="fas fa-save me-2"></i>
                                                <span th:text="${doctor.id == null ? 'Add Doctor' : 'Update Doctor'}">Add Doctor</span>
                                            </span>
                                            <span class="btn-loading d-none">
                                                <span class="loading-spinner me-2"></span>
                                                Saving...
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center text-muted py-3 mt-5">
        <div class="container">
            <p>&copy; 2024 Doctor Registration System. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Enhanced JavaScript -->
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                var alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    var bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);

            // Initialize form validation and progress tracking
            initializeFormValidation();
            updateFormProgress();

            // Add real-time validation
            const form = document.getElementById('doctorForm');
            const inputs = form.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateField(this);
                    updateFormProgress();
                });

                input.addEventListener('blur', function() {
                    validateField(this);
                });
            });

            // Form submission handling
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (validateForm()) {
                    showLoadingState();
                    // Small delay to show loading state
                    setTimeout(() => {
                        this.submit();
                    }, 500);
                }
            });
        });

        // Form validation
        function initializeFormValidation() {
            const form = document.getElementById('doctorForm');
            form.classList.add('needs-validation');
        }

        function validateField(field) {
            const value = field.value.trim();
            const isRequired = field.hasAttribute('required');
            let isValid = true;

            // Remove existing validation classes
            field.classList.remove('is-valid', 'is-invalid');

            if (isRequired && !value) {
                isValid = false;
            } else if (value) {
                // Specific validation based on field type
                switch (field.type) {
                    case 'email':
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        isValid = emailRegex.test(value);
                        break;
                    case 'tel':
                        // Sri Lankan phone number validation
                        // Accepts: +94771234567, 0771234567, 771234567
                        const phoneRegex = /^(\+94|0)?[1-9][0-9]{8}$/;
                        const cleanPhone = value.replace(/[\s\-\(\)]/g, '');
                        isValid = phoneRegex.test(cleanPhone);
                        break;
                    case 'number':
                        const num = parseInt(value);
                        isValid = !isNaN(num) && num >= 0 && num <= 50;
                        break;
                    case 'date':
                        const date = new Date(value);
                        const today = new Date();
                        const minAge = new Date(today.getFullYear() - 80, today.getMonth(), today.getDate());
                        const maxAge = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
                        isValid = date >= minAge && date <= maxAge;
                        break;
                }
            }

            // Apply validation classes
            if (isRequired || value) {
                field.classList.add(isValid ? 'is-valid' : 'is-invalid');
            }

            return isValid;
        }

        function validateForm() {
            const form = document.getElementById('doctorForm');
            const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
            let isFormValid = true;

            inputs.forEach(input => {
                if (!validateField(input)) {
                    isFormValid = false;
                }
            });

            if (!isFormValid) {
                // Show error message
                showNotification('Please fill in all required fields correctly.', 'error');

                // Focus on first invalid field
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return isFormValid;
        }

        // Form progress tracking
        function updateFormProgress() {
            const form = document.getElementById('doctorForm');
            const requiredFields = form.querySelectorAll('input[required], select[required]');
            const validFields = form.querySelectorAll('.is-valid');

            const progress = Math.round((validFields.length / requiredFields.length) * 100);
            const progressBar = document.getElementById('formProgress');
            const progressText = document.getElementById('progressText');

            if (progressBar && progressText) {
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';

                // Change color based on progress
                progressBar.className = 'progress-bar';
                if (progress < 30) {
                    progressBar.classList.add('bg-danger');
                } else if (progress < 70) {
                    progressBar.classList.add('bg-warning');
                } else {
                    progressBar.classList.add('bg-success');
                }
            }
        }

        // Loading state
        function showLoadingState() {
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            submitBtn.disabled = true;
        }

        // Reset form
        function resetForm() {
            const form = document.getElementById('doctorForm');
            form.reset();

            // Remove validation classes
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.remove('is-valid', 'is-invalid');
            });

            updateFormProgress();
            showNotification('Form has been reset.', 'info');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const alertClass = type === 'error' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' :
                                      type === 'success' ? 'check-circle' :
                                      type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            const container = document.querySelector('main .container');
            const existingAlert = container.querySelector('.alert');

            if (existingAlert) {
                existingAlert.remove();
            }

            container.insertAdjacentHTML('afterbegin', alertHtml);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    </script>
</body>
</html>
